****************
Image Processing
****************

Youpi provides several plugins, each of them dedicated to a specific task. In the following 
sections, we will see how to use the user interface (UI) to quickly create jobs ready to be 
sent to a cluster.

.. _proc_fitsin:

`QualityFITS` --- Image Quality Evaluation
==========================================

The Command Line Tool
---------------------

*QualityFITS* is a Terapix tool for evaluating the image quality. Here is a more complete description 
taken from its man page:

[*QualityFITS*] is a pipeline which performs the following steps on preprocessed (debiased and flat-
fielded) images (named ``base.fits``):

    1. runs SExtractor for cosmic ray identification; a FITS mask is produced
    2. runs WeightWatcher using a flat-field (weight map), the cosmic ray mask, detector mask and the 
       input image to produce a weightmap and a flag map (a dummy constant flat field is produced if 
       none was found)
    3. runs SExtractor with a low threshold for stellar and galaxy count histograms, and eventually 
       for further astrometric and photometric calibration
    4. runs SExtractor with a higher threshold to identify bright sources to measure the instrumental 
       PSF
    5. runs PSFEx to construct a PSF model from the sources catalogue extracted in 4
    6. runs Mefhisto which plots histograms of CCD backgrounds, stars and galaxy counts, and writes 
       a FITS table containing CCD backgrounds, FWHM, number of detected sources and other useful 
       quantities, ellipticity map.
    7. run SWarp (resampling and stacking) on the whole mosaic to build a single FITS image.
    8. makes PNG images of the whole mosaic of the original image, the weightmap image and the PSF 
       model. Additional PNG images are also built for each CCD frame with a 4x4 binning factor
    9. these images and quantites are summarized in a webpage

It produces a weight map for later co-addition, a flag map (statistics on image quality), a source 
catalogue, a FITS binary table and a summarizing webpage.

QualityFITS in Youpi
--------------------

Using Youpi for your QualityFITS needs is a convenient place for preparing a job, sending it to a 
cluster and accessing the results directly in a web browser.

Preparing a Job
^^^^^^^^^^^^^^^

As you will see, preparing a job is really easy and is just a matter of selecting input images, 
defining data paths to FLATs, MASKs and REGs files and set up various job parameters:

.. image:: figures/youpi-qfits.png

In the UI, click on the "*processing*" top-level tab and select the QualityFits icon. Several submenus are 
available (from left to right):

*Select images*
    First, use the :ref:`image selector <image_selector_section>` to define a selection of images to process.

*Select data paths*
    Next, select the data paths to the FLAT, MARK and REG data using the :ref:`path selector widget <data_path_selector>`.
    Please note that the paths to FLAT and MASK data files are required. You will get warnings and the job 
    will be discarded if mandatory information is not provided.

*Select a configuration file*
    Select a config file to use for this processing on this set of images using the 
    :ref:`config file selector <config_path_selector>`.

*Set output directory*
    Go to this tab to get the actual output directory that will be used for output results. In most cases, 
    the default value is fine, but you may want to :ref:`set a custom output directory <output_dir_selector>` 
    for the results.

*Options*
    QualityFITS has several options that may alter the way the job is going to be processed on the 
    cluster. The "*Force QualityFits jobs to exit if flat image not found*" and "*Force QualityFits jobs 
    to exit if mask image not found*" are rather self-explaining. The latest option "*Single chip flat 
    field normalization*" will apply a flat field normalization per chip.

Now that everything is set, hit the "*Add to cart*" upper-right button to add the job to the 
:ref:`processing cart <the_processing_cart>`. The job is ready to be submitted to the cluster or to 
be saved to the database for later processing. 

Please note that one cluster job per image is generated. For a list of 4 images to be QualityFITSed, 
4 separate jobs will run on the cluster. Here is what I get on the :ref:`active monitoring <live_monitoring>` 
page:

.. image:: figures/qfits-monitor.png
   :class: capture


Accessing the Results
^^^^^^^^^^^^^^^^^^^^^

Once the jobs are over, go to the "*Results page*" by clicking on the top-level *Results* link. In 
the "*Processing History*" panel on the left, select "*QualityFITS*" and "*my*" to only display your 
latest processing results, then hit the "*Start searching!*" button:

.. _processing_history:

.. image:: figures/qfits-results-criteria.png
   :class: capture

You will get a list of QualityFITS results, one per line. You might want to check out the 
:ref:`processing results <processing_results>` section for more info about using the results 
page. Similarly, I will only describe interesting parts of the result page related to a QualityFITS 
processing only: the :ref:`common parts <pr_common_parts>` are better covered in the 
:ref:`processing results <processing_results>` section too.

Let's select a successful result entry from the list. For example, if I pick the results for image 
``715499p.fits`` in my database:

.. image:: figures/qfits-results-entry.png
   :class: capture

I get some results (on the right side of the window) with sections --- from top to bottom --- related to 
the:

- :ref:`Job duration, owner and exit status <pr_job_stats>`
- Screenshots and thumbnails of the products
- :ref:`User permissions <pr_user_perms>`
- Image grading
- Image tags
- :ref:`Condor job logs <pr_condor_job_logs>`
- This job's :ref:`processing history <pr_proc_history>`
- :ref:`Run parameters <pr_run_params>`
- Image information
- QualityFITS information

*Screenshots and thumbnails*
    This area is a collection of a bigger image on the left and some smaller, grid-aligned thumbnails 
    of the bitmap products:

    .. image:: figures/qfits-results-thumbs.png
       :class: capture

    Just click on the image on the leftmost side to access the full QualityFITS web page, that is 
    the same original page generated by QualityFITS from the command line. If you already know this 
    tool, you may have noticed that this image is actually a thumbnailed version of the HTML page 
    produced after processing. Thumbnails in the grid layout can be clicked to get a bigger version.

*Image grading*
    This part is for grading the image (this is actually the quality evaluation step). It is not 
    graded by default and you have to click on the *"Grade it now!*" link to go to the image's 
    separate grading page:

    .. image:: figures/qfits-results-notgraded.png
       :class: capture

    Please note that only users with the :ref:`grading permission <global_permissions>` are allowed 
    to grade QualityFITSed images. :ref:`Image grading <proc_image_grading>` is covered in greater details 
    in the next section.

*Image tags*
    For convenience, all the tags applied to the current image are displayed in this section:

    .. image:: figures/qfits-results-tags.png
       :class: capture

*Image information*
    This section shows the image's meta data information. All of them --- except for the database 
    ingestion date --- are coming from the image's FITS header. It is provided here for convenience:

    .. image:: figures/qfits-results-imginfo.png
       :class: capture

    .. note:: This information is also available when using the :ref:`image selector <image_selector_section>`.
              Clicking on any image name in the result set will display a notification window with some 
              detailled information too:

                  .. image:: figures/ims-imginfo.png
                     :class: capture

*QualityFITS information*
    Similarly, information related to the QualityFITS processing is displayed. Most values come from the 
    ingestion of data in XML files produced during the processing and permanently stored in the database 
    (for faster and more convenient access) at the end of processing:

    .. image:: figures/qfits-results-qfinfo.png
       :class: capture

Well, we are almost done with the result page description. Now, let's go on with image grading.

.. _proc_image_grading:

Grading an Image
^^^^^^^^^^^^^^^^

Image grading is fully supported within Youpi. An image can be graded by different users and Youpi 
will keep track of the grading history for that image. You can change your grade at anytime by 
editing it. However, only users with the :ref:`grading permission <global_permissions>` are allowed 
to grade images.

Let's grade the image ``715499p.fits`` (used in the previous section). Click on the "*Grade it now!*" 
link to access the QualityFITS result page. You will see the same HTML result page produced by the 
QualityFITS command line tool, enhanced with a header dedicated to image grading:

.. image:: figures/qfits-grading-header.png
   :class: capture

This header is made of two parts. The left part shows the grading history for that image. This image 
has never been graded yet, so the grading history is empty. Can be useful to see whether it has already 
been graded by others. The right part is where you can actually select a grade --- from A to D --- and 
select a predefined comment or type in a custom one (both are optional).

To grade the image, just move the mouse cursor over the little gray stars on the right. The grade will 
change while you move the mouse around. Click on a star to select a grade. Let's say we want to give 
it a B grade by clicking on the third star (from the left). Once clicked, a *commit* button will 
appear. Hit it to save the grade permanently:

.. image:: figures/qfits-grading-gradedB.png
   :class: capture

Once the grade is committed, the grading history is updated too (left part):

.. image:: figures/qfits-grading-postcommit.png
   :class: capture

Now, if you go back to the results page and reload the entry for the image ``715499p.fits``, you will 
see that the *image grading* section shows the available grades. For example, if other users graded 
the same image at the same time, all the grades will appear:

.. image:: figures/qfits-results-grades.png
   :class: capture

Also, the lowest grade is appended to the result entry in the :ref:`processing history <processing_history>` 
panel. This can be a nice way to quickly control whether an image of the results set has been graded:

.. image:: figures/qfits-results-lowestgrade.png
   :class: capture

Reporting
^^^^^^^^^

Last but not least, Youpi has a reporting module with :ref:`dedicated reports <report_qfits>` for 
QualityFITS. Most of them are related to image grading. Here they are:

- :ref:`Grading statistics <reports_qf_gs>`
- :ref:`List of all QualityFITS grade, with comment <reports_qf_laqgwc>`
- :ref:`List of all images with a selected grade <reports_qf_laiwsg>`
- :ref:`List of all non graded images <reports_qf_langi>`
- :ref:`Pie chart of grades <reports_qf_pcog>`

.. _proc_scamp:

`SCAMP` --- Astro-Photo Calibration
===================================

The Command Line Tool
---------------------

`SCAMP`_ (Software for Calibrating AstroMetry and Photometry) is a program that computes astrometric 
projection parameters from source catalogues derived from FITS images. The computed solution is 
expressed according to the WCS standard. The main features of SCAMP are (taken from the official 
documenation):

- Compatibility with SExtractor FITS or MEF catalogue format in input,
- Generation of WCS-compliant and Swarp-compatible FITS image headers in output,
- Automatic grouping of catalogues on the sky
- Selectable on-line astrometic reference catalogue
- Automatic determination of scale, position angle, flippling and coordinate shift using fast 
  pattern-matching
- Several astrometric calibration modes for single detectors and detector arrays
- Combined astrometric solutions for multi-channel/instrument surveys
- Highly configurable astrometric distortion polynomials
- Correction for differential chromatic refraction
- Proper motion measurements
- XML VOTable-compliant output of meta-data

.. _SCAMP: http://www.astromatic.net/software/scamp


SCAMP in Youpi
--------------

Using *SCAMP* in Youpi is a convenient place for preparing a job, sending it to a cluster and accessing the results 
directly in a web browser. As you will see, Youpi also performs some sanity checks to validate input data before 
creating the job.

Preparing a Job
^^^^^^^^^^^^^^^

Preparing a *SCAMP* job is just a matter of selecting input data (data paths, config and job parameters). As you 
can see in the following chart, an *input data validation step* is performed before adding the job to the 
processing cart:

.. image:: figures/youpi-scamp.png

Open the *SCAMP* page by clicking on the "*processing*" top-level tab and select the *SCAMP* icon. Several submenus 
are available (from left to right):

*Select images*
    Use the :ref:`image selector <image_selector_section>` to define a selection of images to process.

*Select data paths*
    Select the data path to ``.ahead`` files using the :ref:`path selector widget <data_path_selector>`.
    Please note that this path is required. You will get a warning and the job will be discarded if 
    it is not provided.

    .. note:: Altough Youpi requires a path to ``.ahead`` files, the low-level *SCAMP* does not. *SCAMP* will use ``.head`` 
              information --- only if available --- to override or add header keywords. This is currently a limitation 
              of Youpi that should be removed in the future. Please check out the "**.head header files**" section in 
              the official `SCAMP documentation`_ (section 5.1.2) for more information.
    
    .. _SCAMP documentation: https://www.astromatic.net/pubsvn/software/scamp/trunk/doc/scamp.pdf

*Select a configuration file*
    Select a config file to use for this processing on this set of images using the 
    :ref:`config file selector <config_path_selector>`.

*Set output directory*
    Go to this tab to get the actual output directory that will be used for output results. In most cases, 
    the default value is fine, but you may want to :ref:`set a custom output directory <output_dir_selector>` 
    for the results.

*Input data validation*
    The "*Add to cart*" button is missing from the *SCAMP* plugin page and is replaced by a "*Validate input data*"
    entry. This is the last step before sending the prepared job to the processing cart.

    Before building the job and adding it to the processing cart, Youpi will perform various checks to 
    ensure matching LDAC files are available to the *SCAMP* low-level program. Since *QualityFITS* processings 
    produce LDAC catalogues (*QualityFITS* uses *Sextractor* internally), Youpi will check, for every image in the 
    current selection, for an existing *successful* *QualityFITS* result. If any LDAC or ``.ahead`` header is 
    missing, Youpi will deny the entire selection of images. If everything is fine, a popup will ask you whether you 
    want to select manually the LDAC files to use for *SCAMP*. 

    By hitting *Cancel*, Youpi will select the latest successful *QualityFITS* job available automatically 
    in order to retreive the LDAC catalogue for every image in the selection. The new job will be added 
    to the processing cart automatically --- there is no "*Add to cart*" button in this case.

    More granular selection is available though: by hitting the *OK* button, a list of selections will be displayed 
    along with a list of LDAC files to use (one list of LDAC files per selection). All selected LDAC files (with the 
    checkbox turned on at the beginning of each row) will be part of the new *SCAMP* job generated when you later 
    click on the "*Add to cart*" button.

    .. note:: The *SCAMP* policy in Youpi is to select the **latest successful** *QualityFITS* job to get the matching LDAC 
              catalogue. Indeed, an image can be processed with QualityFITS any number of times, even by different users
              (remember the :ref:`processing history <pr_proc_history>` section on the result page?). Hence the need for 
              a LDAC selection policy.

Once in the processing cart, you will notice that Youpi generates a single item for the whole *SCAMP* process. 
There will be one single job running on the cluster.

Accessing the Results
^^^^^^^^^^^^^^^^^^^^^

Once the job is over, go to the "*Results page*" by clicking on the top-level *Results* link. In 
the "*Processing History*" panel on the left, select "*SCAMP*" and "*my*" to only display your 
latest processing results, then hit the "*Start searching!*" button:

The Command Line Tool
---------------------

*TBW*

SCAMP in Youpi
--------------

*TBW*

.. _proc_swarp:

`SWarp` --- Image Stacking
==========================

*TBW*

.. _proc_sextractor:

`SExtractor` --- Sources Extractor
==================================

*TBW*

.. _proc_stiff:

`STIFF` --- `FITS` to `TIFF` Image convertion
=============================================

*TBW*
