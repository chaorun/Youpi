****************
Image Processing
****************

Youpi provides several plugins, each of them dedicated to a specific task. In the following 
sections, we will see how to use the user interface (UI) to quickly create jobs ready to be 
sent to a cluster.

.. _proc_fitsin:

`QualityFITS` --- Image Quality Evaluation
==========================================

The Command Line Tool
---------------------

*QualityFITS* is a Terapix tool for evaluating the image quality. Here is a more complete description 
taken from its man page:

[*QualityFITS*] is a pipeline which performs the following steps on preprocessed (debiased and flat-
fielded) images (named ``base.fits``):

    1. runs SExtractor for cosmic ray identification; a FITS mask is produced
    2. runs WeightWatcher using a flat-field (weight map), the cosmic ray mask, detector mask and the 
       input image to produce a weightmap and a flag map (a dummy constant flat field is produced if 
       none was found)
    3. runs SExtractor with a low threshold for stellar and galaxy count histograms, and eventually 
       for further astrometric and photometric calibration
    4. runs SExtractor with a higher threshold to identify bright sources to measure the instrumental 
       PSF
    5. runs PSFEx to construct a PSF model from the sources catalogue extracted in 4
    6. runs Mefhisto which plots histograms of CCD backgrounds, stars and galaxy counts, and writes 
       a FITS table containing CCD backgrounds, FWHM, number of detected sources and other useful 
       quantities, ellipticity map.
    7. run SWarp (resampling and stacking) on the whole mosaic to build a single FITS image.
    8. makes PNG images of the whole mosaic of the original image, the weightmap image and the PSF 
       model. Additional PNG images are also built for each CCD frame with a 4x4 binning factor
    9. these images and quantites are summarized in a webpage

It produces a weight map for later co-addition, a flag map (statistics on image quality), a source 
catalogue, a FITS binary table and a summarizing webpage.

QualityFITS in Youpi
--------------------

Using Youpi for your QualityFITS needs is a convenient place for preparing a job, sending it to a 
cluster and accessing the results directly in a web browser.

Preparing a Job
^^^^^^^^^^^^^^^

As you will see, preparing a job is really easy and is just a matter of selecting input images, 
defining data paths to FLATs, MASKs and REGs files and set up various job parameters:

.. image:: figures/youpi-qfits.png

In the UI, click on the "*processing*" top-level tab and select the QualityFits icon. Several submenus are 
available (from left to right):

*Select images*
    First, use the :ref:`image selector <image_selector_section>` to define a selection of images to process.

*Select data paths*
    Next, select the data paths to the FLAT, MARK and REG data using the :ref:`path selector widget <data_path_selector>`.
    Please note that the paths to FLAT and MASK data files are required. You will get warnings and the job 
    will be discarded if mandatory information is not provided.

*Select a configuration file*
    Select a config file to use for this processing on this set of images using the 
    :ref:`config file selector <config_path_selector>`.

*Set output directory*
    Go to this tab to get the actual output directory that will be used for output results. In most cases, 
    the default value is fine, but you may want to :ref:`set a custom output directory <output_dir_selector>` 
    for the results.

*Options*
    QualityFITS has several options that may alter the way the job is going to be processed on the 
    cluster. The "*Force QualityFits jobs to exit if flat image not found*" and "*Force QualityFits jobs 
    to exit if mask image not found*" are rather self-explaining. The latest option "*Single chip flat 
    field normalization*" will apply a flat field normalization per chip.

Now that everything is set, hit the "*Add to cart*" upper-right button to add the job to the 
:ref:`processing cart <the_processing_cart>`. The job is ready to be submitted to the cluster or to 
be saved to the database for later processing. 

Please note that one cluster job per image is generated. For a list of 4 images to be QualityFITSed, 
4 separate jobs will run on the cluster. Here is what I get on the :ref:`active monitoring <live_monitoring>` 
page:

.. image:: figures/qfits-monitor.png
   :class: capture


Accessing the Results
^^^^^^^^^^^^^^^^^^^^^

Once the jobs are over, go to the "*Results page*" by clicking on the top-level *Results* link. In 
the "*Processing History*" panel on the left, select "*QualityFITS*" and "*my*" to only display your 
latest processing results, then hit the "*Start searching!*" button:

.. image:: figures/qfits-results-criteria.png
   :class: capture

You will get a list of QualityFITS results, one per line. You might want to check out the 
:ref:`processing results <processing_results>` section for more info about using the results 
page. Similarly, I will only describe interesting parts of the result page related to a QualityFITS 
processing only: the :ref:`common parts <pr_common_parts>` are better covered in the 
:ref:`processing results <processing_results>` section too.

Let's select a successful result entry from the list. For example, if I pick the results for image 
``715499p.fits`` in my database:

.. image:: figures/qfits-results-entry.png
   :class: capture

I get some results (on the right side of the window) with sections --- from top to bottom --- related to 
the:

- :ref:`Job duration, owner and exit status <pr_job_stats>`
- Screenshots and thumbnails of the products
- :ref:`User permissions <pr_user_perms>`
- Image grading
- Image tags
- :ref:`Condor job logs <pr_condor_job_logs>`
- This job's :ref:`processing history <pr_proc_history>`
- :ref:`Run parameters <pr_run_params>`
- Image information
- QualityFITS information

*Screenshots and thumbnails*
    This area is a collection of a bigger image on the left and some smaller, grid-aligned thumbnails 
    of the bitmap products:

    .. image:: figures/qfits-results-thumbs.png
       :class: capture

    Just click on the image on the leftmost side to access the full QualityFITS web page, that is 
    the same original page generated by QualityFITS from the command line. If you already know this 
    tool, you may have noticed that this image is actually a thumbnailed version of the HTML page 
    produced after processing. Thumbnails in the grid layout can be clicked to get a bigger version.

*Image grading*
    This part is for grading the image (this is actually the quality evaluation step). It is not 
    graded by default and you have to click on the *"Grade it now!*" link to go to the image's 
    separate grading page:

    .. image:: figures/qfits-results-notgraded.png
       :class: capture

    Please note that only users with the :ref:`grading permission <global_permissions>` are allowed 
    to grade QualityFITSed images. :ref:`Image grading <proc_image_grading>` is covered in greater details 
    in the next section.

*Image tags*
    For convenience, all the tags applied to the current image are displayed in this section:

    .. image:: figures/qfits-results-tags.png
       :class: capture

*Image information*
    This section shows the image's meta data information. All of them --- except for the database 
    ingestion date --- are coming from the image's FITS header. It is provided here for convenience:

    .. image:: figures/qfits-results-imginfo.png
       :class: capture

    .. note:: This information is also available when using the :ref:`image selector <image_selector_section>`.
              Clicking on any image name in the result set will display a notification window with some 
              detailled information too:

                  .. image:: figures/ims-imginfo.png
                     :class: capture

*QualityFITS information*
    Similarly, information related to the QualityFITS processing is displayed. Most values come from the 
    ingestion of data in XML files produced during the processing and permanently stored in the database 
    (for faster and more convenient access) at the end of processing:

    .. image:: figures/qfits-results-qfinfo.png
       :class: capture

We are almost done with the result page description. Now, let's go on with image grading.

.. _proc_image_grading:

Grading an Image
^^^^^^^^^^^^^^^^

TBW

.. _proc_scamp:

`SCAMP` --- Astro-Photo Calibration
===================================

*TBW*

.. _proc_swarp:

`SWarp` --- Image Stacking
==========================

*TBW*

.. _proc_sextractor:

`SExtractor` --- Sources Extractor
==================================

*TBW*

.. _proc_stiff:

`STIFF` --- `FITS` to `TIFF` Image convertion
=============================================

*TBW*
