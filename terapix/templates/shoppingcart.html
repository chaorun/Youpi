{% extends "base_site.html" %}
{% load i18n %}

{% block stylesheet %}/media/themes/{{ user.get_profile.guistyle }}/css/dashboard.css{% endblock %}
{% block coltype %}colMS{% endblock %}
{% block bodyclass %}dashboard{% endblock %}
{% block extrahead %}
<link rel="stylesheet" type="text/css" href="/media/themes/{{ user.get_profile.guistyle }}/css/history.css"/>

<!-- Menu handling -->
<link rel="stylesheet" type="text/css" href="/media/themes/{{ user.get_profile.guistyle }}/css/menu.css"/>
<script type="text/javascript" src="/media/js/menu.js"></script>

<script type="text/javascript" src="/media/js/common.js"></script>
<script type="text/javascript" src="/media/js/xhr.js"></script>
<script type="text/javascript" src="/media/js/condorpanel.js"></script>
<script type="text/javascript">
// Global vars
var guistyle = '{{ user.get_profile.guistyle }}';
var condorPanel = new CondorPanel(null, 'condorPanel');

// trNode: parent TR node
function removeItemFromCart(rid, force) {
	var silent = force == true ? true : false;
	
	if (!silent) {
		var r = confirm('Are you sure you want to delete this item from the cart?');
		if (!r) return;
	}

	var trNode = document.getElementById(rid);
	var pluginName = rid.substr(0, rid.search(/_\d+$/));

	var trs = document.getElementsByTagName('tr');
	var trid, idx, j=0;
	var cartItemsCount = 0;

	for (var k=0; k < trs.length; k++) {
		trid = 	trs[k].getAttribute('id');
		if (!trid) continue;
		if (trid.search(pluginName) == 0) {
			cartItemsCount++;
			if (trs[k] == trNode) {
				idx = j
				break;
			}
			j++;
		}
	}

	// Ask for item deletion
	s_cart.deletePluginItem(
		{'plugin_name' : pluginName, 'idx' : idx},
		// Custom handler called when item deletion is complete
		function() {
			if (cartItemsCount == 1) {
				// No data left in cart, force a page reload
				window.location.reload();
			}
			else {
				// Removes from DOM on successful deletion
				trNode.parentNode.removeChild(trNode);
			}
		}
	);
}

function showSavedItems() {
{% for plugin in plugins %}
	var z = null;
	try {
		z = {{ plugin.id }}_showSavedItems; 
	} catch(e) {
		// Not implemented in plugin
		var countNode = document.getElementById('plugin_{{ plugin.id }}_saved_count');
		countNode.innerHTML = '';
		countNode.appendChild(document.createTextNode('No item'));
		var content = document.getElementById('plugin_menuitem_sub_{{ plugin.id }}');
		content.innerHTML = 'Not implemented yet.';
	}

	if (z) z();
{% endfor %}
}

{% for plugin in plugins %}
var {{ plugin.id }}_drop_box;
var {{ plugin.id }}_item_count = 0;

function {{ plugin.id }}_show_runtime_options() {
	{{ plugin.id }}_drop_box = new DropdownBox('{{ plugin.id }}_drop_box', 
		'{{ plugin.id }}_options_div_{{ forloop.counter }}', 'Runtime Options');
	var r = {{ plugin.id }}_drop_box.getContentNode();
	// Base id
	var id = '{{ plugin.id }}_' + {{ plugin.id }}_item_count;
	
	// Checkbox
	var da = document.createElement('div');
	ia = document.createElement('input');
	ia.setAttribute('id', id + '_reprocess_successful_checkbox');
	ia.setAttribute('type', 'checkbox');
	ia.setAttribute('checked', 'checked');
	var la = document.createElement('label');
	la.appendChild(document.createTextNode('Do not reprocess already successful processings'));
	da.appendChild(ia);
	da.appendChild(la);
	r.appendChild(da);
	
	// Item prefix name
	da = document.createElement('div');
	la = document.createElement('label');
	la.appendChild(document.createTextNode('Item prefix name'));
	ia = document.createElement('input');
	ia.setAttribute('id', id + '_prefix_name_input');
	ia.setAttribute('type', 'text');
	da.appendChild(la);
	da.appendChild(ia);
	r.parentNode.appendChild(da);
	
	// Cluster policy
	da = document.createElement('div');
	da.setAttribute('class', 'cart_item_policy');
	la = document.createElement('div');
	la.appendChild(document.createTextNode('Cluster node policy'));

	// Default option (radio)
	var dd = document.createElement('div');
	var odflt = document.createElement('input');
	odflt.setAttribute('id', id + '_default_radio');
	odflt.setAttribute('onclick', "toggle_node_policy_radio(this.id,'" + id + '_custom_radio' + 
		"','" + id + '_custom_div' + "');");
	odflt.setAttribute('type', 'radio');
	odflt.setAttribute('checked', 'checked');
	odflt.setAttribute('name', id + '_node_policy');
	var dl = document.createElement('label');
	dl.appendChild(document.createTextNode('Use your default Condor setup configuration'));
	dd.appendChild(odflt);
	dd.appendChild(dl);

	// Custom option (radio)
	var cd = document.createElement('div');
	var ocus = document.createElement('input');
	ocus.setAttribute('id', id + '_custom_radio');
	ocus.setAttribute('onclick', "toggle_node_policy_radio('" + id + '_default_radio' + "',this.id,'" +
		id + '_custom_div' + "');");
	ocus.setAttribute('type', 'radio');
	ocus.setAttribute('name', id + '_node_policy');
	var cl = document.createElement('label');
	cl.appendChild(document.createTextNode('Select a custom configuration for this processing'));
	cd.appendChild(ocus);
	cd.appendChild(cl);

	var cc = document.createElement('div');
	cc.setAttribute('id', id + '_custom_div');
	cc.setAttribute('style', 'display: none;');
	cl = document.createElement('label');
	cl.appendChild(document.createTextNode('Select a policy or selection: '));
	var csel = document.createElement('select');
	var copt;
	copt = document.createElement('option');
	copt.appendChild(document.createTextNode('Policies'));
	copt.setAttribute('disabled', 'disabled');
	copt.setAttribute('class', 'header');
	csel.appendChild(copt);

	// Add policies
	{% for pol in policies %}
	copt = document.createElement('option');
	copt.appendChild(document.createTextNode("{{ pol.label }}"));
	copt.setAttribute('class', 'policy');
	{% if forloop.first %}
	copt.setAttribute('selected', 'selected');
	{% endif %}
	csel.appendChild(copt);
	{% endfor %}

	// Add selections
	copt = document.createElement('option');
	copt.appendChild(document.createTextNode('Selections'));
	copt.setAttribute('disabled', 'disabled');
	copt.setAttribute('class', 'header');
	csel.appendChild(copt);
	{% for sel in selections %}
	copt = document.createElement('option');
	copt.appendChild(document.createTextNode("{{ sel.label }}"));
	copt.setAttribute('class', 'selection');
	csel.appendChild(copt);
	{% endfor %}

	cc.appendChild(cl);
	cc.appendChild(csel);

	da.appendChild(la);
	da.appendChild(dd);
	da.appendChild(cd);
	da.appendChild(cc);
	r.parentNode.appendChild(da);
	
	{{ plugin.id }}_item_count++;
}
{% endfor %}

function toggle_node_policy_radio(def_id, cus_id, cus_div_id) {
	var def = document.getElementById(def_id);
	var cus = document.getElementById(cus_id);
	var cusdiv = document.getElementById(cus_div_id);

	cus.checked ? cusdiv.setAttribute('style', 'display: block; padding-left: 20px;') : cusdiv.style.display = 'none';
}

function proceed_cart() {
	alert('TODO...');
}

{# Load custom plugin's javascript code if available #}
{% for plugin in plugins %}
	{% include plugin.jsSource %}
{% endfor %}

</script>

{% endblock %}

<!-- Main body -->
{% block content %}

<div align="center">
<div style="text-align: center;">
	<div>
		<ul class="smart_tabnav_sub" id="menu">
			<li class="enabled">
				<a 	href="#" id="entry_0" 
					onclick="swap_display(this.id, 'menuitem_sub_0', 'menu', 'menuitem_sub_');">Cart items</a>
			</li>
			<li class="disabled">
				<a 	href="#" id="entry_1" 
					onclick="swap_display(this.id, 'menuitem_sub_1', 'menu', 'menuitem_sub_'); showSavedItems();">Saved items</a>
			</li>
		</ul>
		<div align="center" style="width: 100%" id="menuitem_sub_0">
			{# Cart items #}
			{% if cartHasData %}
			<div style="padding-top: 20px;">
			<table width="50%" class="shoppingCart">
			{% for plugin in plugins %}
				{% if plugin.hasItemsInCart %}
				<tr>
					<th>
						<img src="/media/themes/{{ user.get_profile.guistyle }}/img/misc/runall.gif" onclick="{{ plugin.id }}_runAll()"/>
					</th>
					<th colspan="2">{{ plugin.optionLabel }} ({{ plugin.description }}) related items</th>
				</tr>
					{% for data in plugin.getData %}
						{# Invoke custom template rendering #}
				<tr id="{{ plugin.id }}_{{ forloop.counter }}">
					<td style="text-align: right">
						<p style="text-align: right; font-size: 80%">Item <b>{{ plugin.itemPrefix }}{{ data.itemCounter }}</b> added on {{ data.date }}</p>
						<img src="/media/themes/{{ user.get_profile.guistyle }}/img/misc/delete.gif" onclick="removeItemFromCart('{{ plugin.id }}_{{ forloop.counter }}');"/>
					</td>
					<td width="100%" colspan="2">
						<div id="{{ plugin.id }}_options_div_{{ forloop.counter }}"></div>
						<script type="text/javascript">
							{{ plugin.id }}_show_runtime_options();
						</script>
						{% include plugin.itemCartTemplate %}
					</td>
				</tr>
					{% endfor %}
				{% endif %}
			{% endfor %}
				<!--
				<tr>
					<td colspan="3" style="text-align: right; border: none">
						<img src="/media/themes/{{ user.get_profile.guistyle }}/img/misc/proceed.gif"/>
					</td>
				</tr>
				-->
			</table>
			</div>
			{% else %}
			<div style="margin-top: 70px; padding: 5px;">
				{# No data in cart ! #}
				<h1>Your cart is currently empty</h1>
			</div>
			{% endif %}
		</div>
		<div class="cartSavedItems" align="center" id="menuitem_sub_1">
			{# Saved items #}
			<p class="title">
				Please select a type of processing in order to display relevant saved items:
			</p>
			<div class="menu">
				<ul class="icon_smart_tabnav" id="saved_menu">
			{% for plugin in plugins %}
				{% if forloop.first %}
					<li class="enabled">
				{% else %}
					<li class="disabled">
				{% endif %}
						<a 	href="#" id="plugin_entry_{{ forloop.counter0 }}" 
							onclick="swap_display(this.id, 'plugin_menuitem_sub_{{ plugin.id }}', 'saved_menu', 'plugin_menuitem_sub_');">
							<div style="background: transparent url(/media/themes/{{ user.get_profile.guistyle }}/img/32x32/{{ plugin.id }}.png) center left no-repeat; padding-left: 30px;">
								{{ plugin.description }}
								<div id="plugin_{{ plugin.id }}_saved_count" class="count"></div>
							</div>
						</a>
					</li>
			{% endfor %}
				</ul>
			</div>
			{% for plugin in plugins %}
				{% if forloop.first %}
			<div class="content" align="center" id="plugin_menuitem_sub_{{ plugin.id }}">
				{% else %}
			<div clas="content" align="center" style="display: none;" id="plugin_menuitem_sub_{{ plugin.id }}">
				{% endif %}
			</div>
			{% endfor %}
		</div>
	</div>
</div>
</div>
{% endblock %}
