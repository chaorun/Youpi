{% extends "base_site.html" %}
{% load i18n %}

{% block extrahead %}
<script type="text/javascript" src="/media/js/common.js"></script>
<script type="text/javascript" src="/media/js/xhr.js"></script>
<script type="text/javascript" src="/media/js/gradingwidget.js"></script>
<script type="text/javascript" src="/media/js/processinghistorywidget.js"></script>

<script type="text/javascript" src="/media/js/3rdParty/scriptaculous/prototype.js"></script>
<script type="text/javascript" src="/media/js/3rdParty/scriptaculous/scriptaculous.js"></script>
<script type="text/javascript" src="/media/js/3rdParty/lightbox2/lightbox.js"></script>
<link rel="stylesheet" type="text/css" href="/media/js/3rdParty/lightbox2/css/lightbox.css"/>

<!-- Menu handling -->
<link rel="stylesheet" type="text/css" href="/media/themes/{{ user.get_profile.guistyle }}/css/menu.css"/>
<script type="text/javascript" src="/media/js/menu.js"></script>
<script type="text/javascript">
var guistyle = '{{ user.get_profile.guistyle }}';
var currentReturnedData = null;

{# Load custom plugin's javascript code if available #}
{% for plugin in plugins %}
	{% include plugin.jsSource %}
{% endfor %}

// global var
var output_dir_stats_data;

// Get stats
function get_stats() {
	try {
		var dirSel = document.getElementById('dir_select');
	} catch(e) { return false; }

	var dir = dirSel.options[dirSel.selectedIndex].value;
	if (dir == 'empty') return;

	var container = document.getElementById('dir_stats_div');

	var xhr = new HttpRequest(
		container.id,
		null, // Use default error handler
		// Custom handler for results
		function(resp) {
			// custom plugin rendering
			output_dir_stats_data = resp;
			eval(resp['PluginId'] + "_renderOutputDirStats('" + container.id + "');");
		}
	);

	// Checks if a selection of that name already exists
	post = 	'ResultsOutputDir=' + dir;

	// Send HTTP POST request
	xhr.send('/youpi/results/stats/', post);
}
</script>
{% endblock %}

{% block stylesheet %}/media/themes/{{ user.get_profile.guistyle }}/css/dashboard.css{% endblock %}
{% block coltype %}colMS{% endblock %}
{% block bodyclass %}dashboard{% endblock %}

{% block content %}
<div align="center">
	<div id="pre_submenu">
		<ul class="smart_tabnav_sub" id="tabnav2">
			<li class="enabled"><a href="#" id="link_history" onclick="swap_display(this.id, 'menuitem_history', 'tabnav2', 'menuitem_');">History</a></li>
			<li class="disabled"><a href="#" id="link_stats" onclick="swap_display(this.id, 'menuitem_stats', 'tabnav2', 'menuitem_')">Statistics</a></li>
			<li class="disabled"><a href="#" id="link_search" onclick="swap_display(this.id, 'menuitem_search', 'tabnav2', 'menuitem_')">Advanced Search</a></li>
		</ul>
	</div>
	<table class="preingestion">
		<tr id="data">
			<td align="center">
				<div id="menuitem_history">
					<table style="width: 95%">
					<tr><td>
					<div id="history_div"></div>
					</td>
					<td style="width: 100%; margin-right: 20px;">
						<div style="width: 100%;" id="infopanel">
							<div class="tip" style="width: 75%; margin-top: 20px;">
								<p>Just click an entry from the processing history panel on the left to get detailled information about a processing.</p>
								<p>Please note that successful processings are tagged with a <img src="/media/themes/{{ user.get_profile.guistyle }}/img/admin/icon_success.gif"/> flag. Processings that 
								terminate with errors are tagged with a <img src="/media/themes/{{ user.get_profile.guistyle }}/img/admin/icon_error.gif"/> flag. In both cases, associated detailled information offers:
									<ul>
										<li>A complete list of all parameters used for that processing</li>
										<li>A view of the QualityFITS configuration file</li>
										<li>Date-time information</li>
										<li>The job's owner</li>
									</ul>
								</p>
								<p>Successful processings information provides:
									<ul>
										<li>Thumbnails of QualityFITS results</li>
										<li>A direct link to QualityFITS html page</li>
									</ul>
								</p>
								<p>While failed processings information offers:
									<ul>
										<li>A view of the error log file</li>
									</ul>
								</p>
							</div>
						</div>
					</td>
					</tr>
					</table>
				</div>
				<div id="menuitem_stats" style="display: none">
					<div style="margin-top: 20px; width: 500px;" class="tip">
						To get some stats, please select an output directory used for your processings:<br/>
						<select id="dir_select" onchange="get_stats();">
							<option value="empty" selected="selected">---</option>
						{% for dir in outputDirs %}
							<option value="{{ dir }}">{{ dir }}</option>
						{% endfor %}
						</select>
						<img src="/media/themes/{{ user.get_profile.guistyle }}/img/misc/reload.gif" onclick="get_stats();" style="cursor: pointer;" title="Click to reload data..."/>
					</div>
					<div style="margin-top: 20px;" id="dir_stats_div"></div>
				</div>
				<div id="menuitem_search" style="display: none">
				TODO...
				</div>
			</td>
		</tr>
	</table>
</div>
<script type="text/javascript">
	var p = new ProcessingHistoryWidget('history_div', 'p');
	var pInfo = new Array();
	{% for plugin in plugins %}
	pInfo[{{ forloop.counter0 }}] = ['{{ plugin.id }}', '{{ plugin.optionLabel }}'];
	{% endfor %}
	p.setActivePlugins(pInfo);
	p.render();
</script>
{% endblock %}
