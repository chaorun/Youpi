{% extends "base_site.html" %}
{% load i18n %}

{% block extrahead %}
<!-- Javascript treeview -->
<script type="text/javascript" src="/media/js/common.js"></script>
<script type="text/javascript" src="/media/js/xhr.js"></script>
<script type="text/javascript" src="/media/js/gradingwidget.js"></script>

<!-- Menu handling -->
<link rel="stylesheet" type="text/css" href="/media/{{ user.get_profile.guistyle }}/css/menu.css"></script>
<script type="text/javascript" src="/media/js/menu.js"></script>
<script type="text/javascript">
var guistyle = '{{ user.get_profile.guistyle }}';
var currentReturnedData = null;

{# Load custom plugin's javascript code if available #}
{% for plugin in plugins %}
	{% include plugin.jsSource %}
{% endfor %}

// global var
var output_dir_stats_data;

// Get stats
function get_stats() {
	try {
		var dirSel = document.getElementById('dir_select');
	} catch(e) { return false; }

	var dir = dirSel.options[dirSel.selectedIndex].value;
	if (dir == 'empty') return;

	var container = document.getElementById('dir_stats_div');

	var xhr = new HttpRequest(
		container.id,
		null, // Use default error handler
		// Custom handler for results
		function(resp) {
			// custom plugin rendering
			output_dir_stats_data = resp;
			eval(resp['PluginId'] + "_renderOutputDirStats('" + container.id + "');");
		}
	);

	// Checks if a selection of that name already exists
	post = 	'ResultsOutputDir=' + dir;

	// Send HTTP POST request
	xhr.send('/spica2/results/stats/', post);
}

// Results filtering
function apply_filter() {
	try {
		var ownerSel = document.getElementById('owner_select');
		var statusSel = document.getElementById('status_select');
		var kindSel = document.getElementById('kind_select');
		var filter = document.getElementById('filter_text');
	} catch(e) { return false; }

	var owner = ownerSel.options[ownerSel.selectedIndex].value;
	var status = statusSel.options[statusSel.selectedIndex].value;
	var kind = kindSel.options[kindSel.selectedIndex].value;
	var filterText = filter.value;

	var container = document.getElementById('tasks_div');
	var xhr = new HttpRequest(
		container.id,
		null, // Use default error handler
		// Custom handler for results
		function(resp) {
			container.innerHTML = '';
			var r = resp['results'];
			var len = r.length;
			var tab = document.createElement('table');
			tab.setAttribute('class', 'results');

			var tr, td, cls, stab, str, std, d, img, gdiv;

			if (status == 'failed' && len && kind != 'all') {
				var rdiv = document.createElement('div');
				rdiv.setAttribute('id', 'reprocess_failed_div');
				rdiv.setAttribute('class', 'reprocess');
				var rimg = document.createElement('img');
				rimg.setAttribute('onclick', kind + "_reprocess_all_failed_processings('" + resp['Stats']['TasksIds'] + "');");
				rimg.setAttribute('src', '/media/{{ user.get_profile.guistyle }}/img/misc/reprocess.gif');
				rdiv.appendChild(rimg);
				rdiv.appendChild(document.createTextNode(' that current selection of processings that never succeeded'));
				container.appendChild(rdiv);
			}

			// Updates stats
			var spans = ['success', 'failed', 'total', 'big_total'];
			for (var k=0; k < spans.length; k++) {
				var node = document.getElementById(spans[k] + '_span');
				node.innerHTML = '';
				node.appendChild(document.createTextNode(resp['Stats']['nb_' + spans[k]]));
			}

			if (!len) {
				tr = document.createElement('tr');	
				td = document.createElement('td');	
				td.setAttribute('style', 'color: grey; cursor: default;');
				td.innerHTML = '<h2>No results found.</h2>';
				tr.appendChild(td);
				tab.appendChild(tr);
				container.appendChild(tab);
				return;
			}

			for (var k=0; k < len; k++) {
				cls = r[k]['Success'] ?'success' : 'failure';
				tr = document.createElement('tr');	
				tr.setAttribute('id', 'res_' + r[k]['Id']);
				tr.setAttribute('class', cls);
				tr.setAttribute('onmouseover', "this.setAttribute('class', 'mouseover_" + cls + "');");
				tr.setAttribute('onmouseout', "this.setAttribute('class', '" + cls + "');");
				tr.setAttribute('onclick', "results_showDetails('" + r[k]['Name'] + "'," + r[k]['Id'] + ", true);");
				tab.appendChild(tr);

				// Description
				td = document.createElement('td');	
				td.innerHTML = r[k]['CustomDescr'];
				d = document.createElement('div');	
				td.appendChild(d);
				tr.appendChild(td);

				// Misc info
				stab = document.createElement('table');
				str = document.createElement('tr');	

				std = document.createElement('td');	
				std.setAttribute('nowrap', 'nowrap');
				gdiv = document.createElement('div');	
				gdiv.setAttribute('class', 'user');
				gdiv.appendChild(document.createTextNode(r[k]['User']));
				std.appendChild(gdiv);

				gdiv = document.createElement('div');	
				gdiv.setAttribute('class', 'node');
				gdiv.appendChild(document.createTextNode(r[k]['Node']));
				std.appendChild(gdiv);
				str.appendChild(std);

				std = document.createElement('td');	
				std.setAttribute('nowrap', 'nowrap');
				gdiv = document.createElement('div');	
				gdiv.setAttribute('class', 'clock');
				gdiv.appendChild(document.createTextNode(r[k]['Start']));
				gdiv.appendChild(document.createElement('br'));
				gdiv.appendChild(document.createTextNode(r[k]['Duration'] + ' sec'));
				std.appendChild(gdiv);
				str.appendChild(std);

				std = document.createElement('td');	
				std.setAttribute('class', 'exit');
				str.appendChild(std);

				stab.appendChild(str);
				d.appendChild(stab);
				tr.appendChild(td);

				tab.appendChild(tr);
			}

			container.appendChild(tab);
		}
	);

	// Checks if a selection of that name already exists
	post = 	'Owner=' + owner + 
			'&Status=' + status + 
			'&Kind=' + kind +
			'&FilterText=' + filterText;

	// Send HTTP POST request
	xhr.setBusyMsg('Please wait while filtering processing data');
	xhr.send('/spica2/results/filter/', post);
}

function filter_text_handler(event) {
	var filter = document.getElementById('filter_text');
	// Return key pressed ?
	if (event.which == 13) {
		apply_filter();
	}
	return true;
}

</script>
{% endblock %}

{% block stylesheet %}/media/{{ user.get_profile.guistyle }}/css/dashboard.css{% endblock %}
{% block coltype %}colMS{% endblock %}
{% block bodyclass %}dashboard{% endblock %}

{% block content %}
<div align="center">
	<table class="preingestion">
		<tr>
			<td>
				<div id="pre_submenu">
					<ul class="smart_tabnav" id="tabnav2">
						<li class="enabled"><a href="#" id="link_history" onclick="swap_display(this.id, 'menuitem_history', 'tabnav2', 'menuitem_');">History</a></li>
						<li class="disabled"><a href="#" id="link_stats" onclick="swap_display(this.id, 'menuitem_stats', 'tabnav2', 'menuitem_')">Statistics</a></li>
						<li class="disabled"><a href="#" id="link_search" onclick="swap_display(this.id, 'menuitem_search', 'tabnav2', 'menuitem_')">Advanced Search</a></li>
					</ul>
				</div>
			</td>
		</tr>

		<tr id="data">
			<td align="center">
				<div id="menuitem_history">
					<table style="width: 95%">
					<tr><td>
					<table class="fileBrowser" style="width: 450px">
						<tr><th>Processing history</th></tr>
						<tr>
							<td>
								<table class="results-filter">
									<tr>
										<td>
											<img src="/media/{{ user.get_profile.guistyle }}/img/admin/selector-search.gif"/>
											<input id="filter_text" type="text" title="Press Enter to filter tasks" onkeyup="return filter_text_handler(event);" size="40"/>
											<img src="/media/{{ user.get_profile.guistyle }}/img/misc/reset.png" title="Reset field" style="cursor: pointer;" onclick="var t=document.getElementById('filter_text'); t.value=''; apply_filter(); t.focus();"/>
										</td>
										<td>
											<img src="/media/{{ user.get_profile.guistyle }}/img/admin/icon_success.gif"/><span id="success_span"></span>
											<img src="/media/{{ user.get_profile.guistyle }}/img/admin/icon_error.gif"/><span id="failed_span"></span> (<span id="total_span"></span>/<span id="big_total_span"></span>)
										</td>
									</tr>
									{% if plugins %}
									<tr>
										<td class="filter" nowrap="nowrap" colspan="2">
											<form>
												<img src="/media/{{ user.get_profile.guistyle }}/img/16x16/filter.png"/>
												<label>Show</label>
												<select id="owner_select" onchange="apply_filter();">
													 <option selected="selected">all</option>
													 <option>my</option>
													 <option>others</option>
												</select>
												<select id="status_select" onchange="apply_filter();">
													 <option>successful</option>
													 <option>failed</option>
													 <option selected="selected">finished</option>
												</select>
												<select id="kind_select" onchange="apply_filter();">
													 <option value="all" selected="selected">processings (any type)</option>
										{% for plugin in plugins %}
													 <option value="{{ plugin.id }}">{{ plugin.optionLabel }} processings</option>
										{% endfor %}
												</select>
												<img src="/media/{{ user.get_profile.guistyle }}/img/misc/reset.png" title="Reset filter" style="cursor: pointer;" onclick="this.parentNode.reset(); apply_filter(); document.getElementById('filter_text').focus();"/>
											</form>
										</td>
									</tr>
									{% endif %}
								</table>
								<div id="tasks_div" style="border-top: 1px #5b80b2 solid; height: 400px; overflow: auto">
								</div>
							</td>
						</tr>
					</table>
					</td>
					<td style="width: 100%; margin-right: 20px;">
						<div style="width: 100%;" id="infopanel">
							<div class="tip" style="width: 75%; margin-top: 20px;">
								<p>Just click an entry from the processing history panel on the left to get detailled information about a processing.</p>
								<p>Please note that successful processings are tagged with a <img src="/media/{{ user.get_profile.guistyle }}/img/admin/icon_success.gif"/> flag. Processings that 
								terminate with errors are tagged with a <img src="/media/{{ user.get_profile.guistyle }}/img/admin/icon_error.gif"/> flag. In both cases, associated detailled information offers:
									<ul>
										<li>A complete list of all parameters used for that processing</li>
										<li>A view of the QualityFITS configuration file</li>
										<li>Date-time information</li>
										<li>The job's owner</li>
									</ul>
								</p>
								<p>Successful processings information provides:
									<ul>
										<li>Thumbnails of QualityFITS results</li>
										<li>A direct link to QualityFITS html page</li>
									</ul>
								</p>
								<p>While failed processings information offers:
									<ul>
										<li>A view of the error log file</li>
									</ul>
								</p>
							</div>
						</div>
					</td>
					</tr>
					</table>
				</div>
				<div id="menuitem_stats" style="display: none">
					To get some stats, please select an output directory used for your processings:<br/>
					<select id="dir_select" onchange="get_stats();">
						<option value="empty" selected="selected">---</option>
					{% for dir in outputDirs %}
						<option value="{{ dir }}">{{ dir }}</option>
					{% endfor %}
					</select>
					<img src="/media/{{ user.get_profile.guistyle }}/img/misc/reload.gif" onclick="get_stats();" style="cursor: pointer;" title="Click to reload data..."/>
					<div style="margin-top: 20px;" id="dir_stats_div"></div>
				</div>
				<div id="menuitem_search" style="display: none">
				TODO...
				</div>
			</td>
		</tr>
	</table>
</div>
<script type="text/javascript">
	apply_filter();
	document.getElementById('filter_text').focus();
</script>

{% endblock %}
