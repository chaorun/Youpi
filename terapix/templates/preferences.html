{% extends "base_site.html" %}
{% load i18n %}

{% block stylesheet %}/media/themes/{{ user.get_profile.guistyle }}/css/dashboard.css{% endblock %}
{% block coltype %}colMS{% endblock %}
{% block bodyclass %}dashboard{% endblock %}
{% block extrahead %}
<link rel="stylesheet" type="text/css" href="/media/themes/{{ user.get_profile.guistyle }}/css/history.css"></script>
<link rel="stylesheet" type="text/css" href="/media/themes/{{ user.get_profile.guistyle }}/css/menu.css"></script>

<script type="text/javascript" src="/media/js/common.js"></script>
<script type="text/javascript" src="/media/js/xhr.js"></script>
<script type="text/javascript" src="/media/js/menu.js"></script>
<script type="text/javascript" src="/media/js/condorpanel.js"></script>

<script type="text/javascript">
var guistyle = '{{ user.get_profile.guistyle }}';

function set_current_theme(name) {
	var xhr = new HttpRequest(
			null,
			null,	
			// Custom handler for results
			function(resp) {
				window.location.reload();
			}
	);

	var post = 'Name=' + name;
	xhr.send('/youpi/preferences/theme/set/', post);
}

function show_available_themes() {
	var d = document.getElementById('all_themes_div');
	var tab = document.createElement('table');
	var tr, td, img, meta;
	var meta, name, desc;

	tr = document.createElement('tr');
	{% for theme in themes %}
	td = document.createElement('td');
	img = document.createElement('img');
	img.setAttribute('src', '/media/themes/{{ theme.short_name }}/screenshot.png');
	img.setAttribute('onclick', "set_current_theme('{{ theme.short_name }}');");
	img.setAttribute('title', "Use {{ theme.name }} as default theme");
	meta = document.createElement('div');

	name = document.createElement('div');
	name.setAttribute('class', 'name');
	name.appendChild(document.createTextNode('{{ theme.name }}'));

	desc = document.createElement('div');
	desc.setAttribute('class', 'description');
	desc.appendChild(document.createTextNode('{{ theme.description }}'));

	meta.appendChild(name);
	meta.appendChild(desc);
	td.appendChild(img);
	td.appendChild(meta);
	tr.appendChild(td);
	{% endfor %}

	tab.appendChild(tr);
	d.appendChild(tab);
}

function show_current_config_button(container_id) {
	var c = document.getElementById(container_id);
	var but = document.createElement('input');
	but.setAttribute('type', 'button');
	but.setAttribute('value', 'Save current configuration');
	but.setAttribute('onclick', "save_config(this.nextSibling);");
	c.appendChild(but);

	var ldiv = document.createElement('div');
	c.appendChild(ldiv);

}

function save_config(logNode) {
	var log = new Logger(logNode);

	// Build POST data
	// Default Behaviour
	var selsuff = ['_def_behaviour_select', '_pol_select', '_sel_select'];
	var kind = ['DB', 'DP', 'DS'];
	var post = '';
	var sel;

	for (var k=0; k < selsuff.length; k++) {
		post += (k > 0 ? '&' : '') + kind[k] + '=';
{% for plugin in plugins %}
		sel = document.getElementById('{{ plugin.id }}' + selsuff[k]);
		post += sel.options[sel.selectedIndex].value + ','
{% endfor %}
		post = post.substr(0, post.length-1);
	}

	var r = new HttpRequest(
		null,
		null,	
		function(resp) {
			log.clear();
			if (resp['Error']) {
				log.msg_error(resp['Error']);
				return;
			}
			log.msg_ok('Configuration successfully saved.');
		}
	);

	r.send('/youpi/preferences/condor/saveCurrentConfig/', post);
}

function load_config() {
	var config = "{{ config }}".replace(/&#39;/g, "'");
	if (config == 'None') return;

	config = eval('(' + config + ')');
	var selsuff = ['_def_behaviour_select', '_pol_select', '_sel_select'];
	var kind = ['DB', 'DP', 'DS'];
	var sel;
	var pid;

	for (var k=0; k < selsuff.length; k++) {
{% for plugin in plugins %}
		pid = '{{ plugin.id }}';
		sel = document.getElementById(pid + selsuff[k]);
		for (var j=0; j < sel.options.length; j++) {
			if (sel.options[j].value == config[pid][kind[k]]) {
				sel.options[j].setAttribute('selected', 'selected');
				break;
			}
		}
{% endfor %}
	}
}
</script>
{% endblock %}

<!-- Main body -->
{% block content %}
<div>
	<ul class="smart_tabnav_sub" id="menu">
		<li class="enabled">
			<a 	href="#" id="entry_0" 
				onclick="swap_display(this.id, 'menuitem_sub_0', 'menu', 'menuitem_sub_');">Themes</a>
		</li>
		<li class="disabled">
			<a 	href="#" id="entry_1" 
				onclick="swap_display(this.id, 'menuitem_sub_1', 'menu', 'menuitem_sub_');">Default Condor Setup</a>
		</li>
	</ul>
	<div style="width: 100%" id="menuitem_sub_0">
		<div id="current_theme_div" class="themes">
			<h1>Current Theme</h1>
			<div class="curtheme">
				<table>
					<tr>
						<td>
							<img src="/media/themes/{{ user.get_profile.guistyle }}/screenshot.png"/>
						</td>
						<td>
							<div class="name">{{ current_theme.name }} <span class="version">{{ current_theme.version }}</span></div> 
							by <a href="{{ current_theme.author_uri }}"><span class="author">{{ current_theme.author }}</span></a>
							<div class="description">{{ current_theme.description }}</div>
						</td>
					</tr>
				</table>
			</div>

			<h1>Available Themes</h1>
			<div id="all_themes_div" class="allthemes"></div>
		</div>
	</div>
	<div style="width: 100%; display: none;" id="menuitem_sub_1">
		<div id="condor_global_log" class="prefs_condor"></div>
		<div id="top_save_div" class="prefs_condor"></div>
		<div class="prefs_condor">
			<h1>Default Shopping Cart Item Behaviour</h1>
			You can configure cart's items to use either your default <b>policy</b> or <b>selection</b> automatically as 
			a default choice.
			<div style="margin-top: 10px;">
				<table class="defaultCondorSetup">
				{% for plugin in plugins %}
					<tr>
						<td>
							{{ plugin.optionLabel }}
						</td>
						<td>
							<label>use default </label>
							<select id="{{ plugin.id }}_def_behaviour_select">
								<option>policy</option>	
								<option>selection</option>	
							</select>
						</td>
					</tr>
				{% endfor %}
				</table>
			</div>
		</div>
		<div class="prefs_condor">
			<h1>Default Policy</h1>
			<table class="defaultCondorSetup">
			{% for plugin in plugins %}
				<tr>
					<td>{{ plugin.optionLabel }}</td>
					<td>
						<select id="{{ plugin.id }}_pol_select">
				{% for pol in policies %}
							<option>{{ pol.label }}</option>	
				{% endfor %}
						</select>
					</td>
				</tr>
			{% endfor %}
			</table>
		</div>
		<div class="prefs_condor">
			<h1>Default Selection</h1>
			<table class="defaultCondorSetup">
			{% for plugin in plugins %}
				<tr>
					<td>{{ plugin.optionLabel }}</td>
					<td>
						<select id="{{ plugin.id }}_sel_select">
				{% for sel in selections %}
							<option>{{ sel.label }}</option>	
				{% endfor %}
						</select>
					</td>
				</tr>
			{% endfor %}
			</table>
		</div>
		<div id="bottom_save_div" class="prefs_condor"></div>
	</div>
</div>

<script type="text/javascript">
	show_available_themes();
	show_current_config_button('top_save_div');
	show_current_config_button('bottom_save_div');
	load_config();
</script>
{% endblock %}
